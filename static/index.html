<!DOCTYPE html>
<html>
<head>
    <title>LLM Response</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header style="background-color: #f0f0f0; color: #333; padding: 10px; text-align: center;">
        <h1>Product Owner Copilot</h1>
    </header>
    <form id="prompt-form" style="margin-bottom: 1em;">
        <label for="template-select">Select template:</label>
        <select id="template-select" name="template">
            <option value="pbi">PBI</option>
            <option value="product_goal">Product Goal</option>
        </select><br><br>
        <label for="prompt-input">Enter your prompt:</label><br>
        <textarea id="prompt-input" name="prompt" rows="4" style="width:100%;"></textarea><br>
        <button type="submit">Submit</button>
        <button type="button" id="clear-btn">Clear</button>
    </form>
    <h2>LLM Response:</h2>
    <div id="llm-response-area" class="llm-response">
        <textarea id="llm-response" style="width: 100%; min-height: 300px; resize: vertical; white-space: pre-wrap; word-break: break-word; font-family: monospace;">Loading...</textarea>
    </div>
    <p>Disclaimer: The output above is generated by an AI model and may not always be accurate or appropriate.</p>
    <div style="background-color: #333; color: white; padding: 10px; text-align: center; font-weight: bold;">
        EXPERIMENTAL PROJECT - Use with caution.
    </div>
    <script>
    // Handle form submission
    document.getElementById('prompt-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const prompt = document.getElementById('prompt-input').value;
        const template = document.getElementById('template-select').value;
        if (prompt) {
            // Do not clear the prompt field
            window.location.search = '?prompt=' + encodeURIComponent(prompt) + '&template=' + encodeURIComponent(template);
        }
    });

    // Add Clear button functionality
    document.getElementById('clear-btn').addEventListener('click', function() {
        document.getElementById('prompt-input').value = '';
        document.getElementById('llm-response').value = '';
        // Optionally, remove query params from URL
        window.history.replaceState({}, document.title, window.location.pathname);
    });

    // Handle streaming fetch on page load if prompt is present
    function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }
    const prompt = getQueryParam('prompt');
    const template = getQueryParam('template') || 'pbi';
    const responseArea = document.getElementById('llm-response');
    // Set prompt textarea value from query param if present
    if (prompt !== null) {
        document.getElementById('prompt-input').value = prompt;
    }
    if (prompt) {
        const streamUrl = `/stream_result?prompt=${encodeURIComponent(prompt)}&template=${encodeURIComponent(template)}`;
        fetch(streamUrl)
            .then(response => {
                if (!response.body) {
                    responseArea.value = 'No response body.';
                    return;
                }
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                responseArea.value = '';
                function read() {
                    reader.read().then(({ done, value }) => {
                        if (done) return;
                        responseArea.value += decoder.decode(value, { stream: true });
                        responseArea.scrollTop = responseArea.scrollHeight;
                        read();
                    }).catch(err => {
                        responseArea.value += '\n[Stream error: ' + err + ']';
                    });
                }
                read();
            })
            .catch(err => {
                responseArea.value = '[Fetch error: ' + err + ']';
            });
    } else {
        responseArea.value = '';
    }
    </script>
</body>
</html>
