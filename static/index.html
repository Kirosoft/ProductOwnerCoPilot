<!DOCTYPE html>
<html>
<head>
    <title>LLM Response</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header style="background-color: #f0f0f0; color: #333; padding: 10px; text-align: center;">
        <h1>Product Owner Copilot</h1>
    </header>
    <form id="prompt-form" style="margin-bottom: 1em;">
        <label for="template-select">Select template:</label>
        <select id="template-select" name="template">
            <option value="pbi">PBI</option>
            <option value="product_goal">Product Goal</option>
        </select><br><br>
        <label for="prompt-input">Enter your prompt:</label><br>
        <textarea id="prompt-input" name="prompt" rows="4" style="width:100%;"></textarea><br>
        <button type="submit">Submit</button>
        <button type="button" id="clear-btn">Clear</button>
        <button type="button" id="cancel-btn" disabled>Cancel</button>
    </form>
    <h2>LLM Response & Review:</h2>
    <div id="llm-response-area" class="llm-response" style="display: flex; gap: 1em;">
        <div style="flex: 1; display: flex; flex-direction: column;">
            <label for="llm-response" style="font-weight: bold;">LLM Response</label>
            <textarea id="llm-response" style="width: 100%; min-height: 300px; resize: vertical; white-space: pre-wrap; word-break: break-word; font-family: monospace;">Loading...</textarea>
        </div>
        <div style="flex: 1; display: flex; flex-direction: column;">
            <label for="review-response" style="font-weight: bold;">Review</label>
            <textarea id="review-response" style="width: 100%; min-height: 300px; resize: vertical; white-space: pre-wrap; word-break: break-word; font-family: monospace;">Waiting for LLM response...</textarea>
        </div>
    </div>
    <p>Disclaimer: The output above is generated by an AI model and may not always be accurate or appropriate.</p>
    <div style="background-color: #333; color: white; padding: 10px; text-align: center; font-weight: bold;">
        EXPERIMENTAL PROJECT - Use with caution.
    </div>
    <script>
    // Handle form submission
    document.getElementById('prompt-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const prompt = document.getElementById('prompt-input').value;
        const template = document.getElementById('template-select').value;
        if (prompt) {
            // Do not clear the prompt field
            window.location.search = '?prompt=' + encodeURIComponent(prompt) + '&template=' + encodeURIComponent(template);
        }
    });

    // Add Clear button functionality
    document.getElementById('clear-btn').addEventListener('click', function() {
        document.getElementById('prompt-input').value = '';
        document.getElementById('llm-response').value = '';
        document.getElementById('review-response').value = '';
        // Optionally, remove query params from URL
        window.history.replaceState({}, document.title, window.location.pathname);
    });

    let abortController = null;
    const cancelBtn = document.getElementById('cancel-btn');

    // Add Cancel button functionality
    cancelBtn.addEventListener('click', function() {
        if (abortController) {
            abortController.abort();
            cancelBtn.disabled = true;
        }
    });

    // Handle streaming fetch on page load if prompt is present
    function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }
    const prompt = getQueryParam('prompt');
    const template = getQueryParam('template') || 'pbi';
    const responseArea = document.getElementById('llm-response');
    const reviewArea = document.getElementById('review-response');
    // Set prompt textarea value from query param if present
    if (prompt !== null) {
        document.getElementById('prompt-input').value = prompt;
    }
    if (prompt) {
        const streamUrl = `/stream_result?prompt=${encodeURIComponent(prompt)}&template=${encodeURIComponent(template)}`;
        abortController = new AbortController();
        cancelBtn.disabled = false;
        reviewArea.value = 'Waiting for LLM response...';
        fetch(streamUrl, { signal: abortController.signal })
            .then(response => {
                if (!response.body) {
                    responseArea.value = 'No response body.';
                    cancelBtn.disabled = true;
                    reviewArea.value = '';
                    return;
                }
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                responseArea.value = '';
                let llmResult = '';
                function read() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            cancelBtn.disabled = true;
                            // After LLM response is done, trigger review
                            if (llmResult.trim()) {
                                triggerReview(llmResult);
                            } else {
                                reviewArea.value = '';
                            }
                            return;
                        }
                        const chunk = decoder.decode(value, { stream: true });
                        responseArea.value += chunk;
                        llmResult += chunk;
                        responseArea.scrollTop = responseArea.scrollHeight;
                        read();
                    }).catch(err => {
                        if (err.name === 'AbortError') {
                            responseArea.value += '\n[Stream cancelled by user]\n';
                        } else {
                            responseArea.value += '\n[Stream error: ' + err + ']';
                        }
                        cancelBtn.disabled = true;
                        reviewArea.value = '';
                    });
                }
                read();
            })
            .catch(err => {
                if (err.name === 'AbortError') {
                    responseArea.value = '[Fetch cancelled by user]';
                } else {
                    responseArea.value = '[Fetch error: ' + err + ']';
                }
                cancelBtn.disabled = true;
                reviewArea.value = '';
            });
    } else {
        responseArea.value = '';
        reviewArea.value = '';
        cancelBtn.disabled = true;
    }

    // Function to trigger review LLM call
    function triggerReview(llmText) {
        // Use a special template for review
        const reviewUrl = `/stream_result?prompt=${encodeURIComponent(llmText)}&template=po_review`;
        reviewArea.value = '';
        fetch(reviewUrl)
            .then(response => {
                if (!response.body) {
                    reviewArea.value = 'No response body.';
                    return;
                }
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                function read() {
                    reader.read().then(({ done, value }) => {
                        if (done) return;
                        reviewArea.value += decoder.decode(value, { stream: true });
                        reviewArea.scrollTop = reviewArea.scrollHeight;
                        read();
                    }).catch(err => {
                        reviewArea.value += '\n[Stream error: ' + err + ']';
                    });
                }
                read();
            })
            .catch(err => {
                reviewArea.value = '[Fetch error: ' + err + ']';
            });
    }
    </script>
</body>
</html>
